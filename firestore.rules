rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Users can read and write their own data
    match /users/{userId} {
      // Allow read if authenticated and is the owner
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow create for any authenticated user (for first-time sign-up)
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow update/delete only for the owner
      allow update, delete: if request.auth != null && request.auth.uid == userId;
      
      // Users can only manage their own emergency contacts
      match /emergency_contacts/{contactId} {
        allow read, write, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Allow logged-in users to read vehicle data
    match /vehicles/{vehicleId} {
      allow read: if request.auth != null;
    }
    
    // Allow logged-in users to submit reports
    match /vehicle_reports/{reportId} {
      allow create: if request.auth != null;
    }

    // Allow logged-in users to read and create redeemed vouchers for themselves
    match /redeemed_vouchers/{voucherId} {
        allow read: if request.auth != null && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Allow logged-in users to read and create rides
    match /rides/{rideId} {
        allow read, create: if request.auth != null;
    }

    // Ride requests can be created by any authenticated user.
    // They can only be read by the driver or the requester.
    match /ride_requests/{requestId} {
        allow create: if request.auth != null;
        allow read, update: if request.auth != null && (request.auth.uid == resource.data.driverId || request.auth.uid == resource.data.requesterId);
    }
  }
}
